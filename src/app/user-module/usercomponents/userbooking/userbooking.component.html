<div class="flex-col flex h-screen gap-3">

    <!-- Filter and search controls -->
    <h3 class="text-2xl text-gray-500 dark:text-white font-serif">Booking Data</h3>
    <div class="flex justify-between mb-4 flex-wrap">
        <!-- Filter options -->
        <div class="flex flex-col gap-1">
            <span class="text-[15px] text-gray-600 dark:text-gray-300">Sort by Bookings</span>
            <select [(ngModel)]="filterType" (change)="filterBookings()"
                class="border border-gray-300 rounded-md p-1 mr-2">
                <option value="All">All</option>
                <option value="Today">Today</option>
                <option value="Upcoming">Upcoming</option>
                <option value="Yesterday">Yesterday</option>
                <option value="Visited">Visited</option>
                <option value="NotVisited">Not Visited</option>
            </select>
        </div>
        <!-- Search by user email -->
        <div class="flex flex-col gap-1">
            <span class="text-[15px] text-gray-600 dark:text-gray-300">Search by user email</span>
            <input type="text" [(ngModel)]="searchTerm" (input)="filterBookings()" placeholder="Search by User Email"
                class="border border-gray-300 rounded-md p-1">
        </div>

        <!-- Filter by Date -->
        <div class="flex flex-col gap-1">
            <span class="text-[15px] text-gray-600 dark:text-gray-300">Search by date</span>
            <input type="date" [(ngModel)]="filterDate" (input)="filterBookings()" placeholder="filter by date"
                class="border border-gray-300 rounded-md p-1">
        </div>


        <!-- Search by userid -->
        <div class="flex flex-col gap-1">
            <span class="text-[15px] text-gray-600 dark:text-gray-300">Search by station id</span>
            <input type="text" [(ngModel)]="stationid" (input)="filterBookings()" placeholder="Search by User Email"
                class="border border-gray-300 rounded-md p-1">
        </div>


    </div>
    <!-- Second grid section -->
    <div class="h-screen  overflow-y-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-2 gap-4 mt-2 mb-3">
            <ng-container *ngFor="let booking of filteredBookings; let i = index">
                <div class="bg-white dark:bg-slate-800 shadow-lg rounded-lg  w-full border border-gray-400">
                    <div class="px-4 py-2">
                        <h3 class="text-lg font-semibold dark:text-gray-200 text-gray-700">{{ booking.evid }}</h3>
                        <hr />

                        <!-- Booking Details -->
                        <h5 class="text-lg text-gray-500 dark:text-gray-400">Booking Details</h5>
                        <!-- Display booking data -->
                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">User Id: {{ booking.userId }}</p>
                            <p class="text-gray-500 text-sm">Station Id: {{ booking.stationId }}</p>
                        </div>

                        <!-- Display remaining booking details -->
                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">Booked For: {{ booking.bookedForDate }}</p>
                            <p class="text-gray-500 text-sm">Time: {{ booking.timeForBooked }}</p>
                        </div>

                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm"> Hours of Booking: {{ booking.totalHoursEvBooking }}
                                hrs.
                            </p>
                            <p class="text-gray-500 text-sm">Expected End Time: {{
                                calculateExpectedEndTime(booking.timeForBooked, booking.totalHoursEvBooking) }}</p>
                        </div>


                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">Status: {{ booking.visitingStatus }}</p>
                            <p class="text-gray-500 text-sm">Booking Slot: {{ booking.bookingSlot }}</p>
                        </div>
                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">Total Payable: ₹{{ booking.totalPayable }}</p>
                            <p class="text-gray-500 text-sm">Remark: {{ booking.remark }}</p>
                        </div>

                        <hr class="mb-2 mt-2" />
                        <!-- Display Payment Details -->
                        <h5 class="text-lg text-gray-500 dark:text-gray-400">Payment Details</h5>
                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">Payment Type: {{ booking.paymentDetails.paymentType }}
                            </p>
                            <p class="text-gray-500 text-sm">Payment Status: {{ booking.paymentDetails.paymentStatus
                                }}</p>
                        </div>
                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">Payment Amount: ₹{{ booking.paymentDetails.amount }}
                            </p>
                            <p class="text-gray-500 text-sm">Payment Transaction ID: {{
                                booking.paymentDetails.transactionid }}
                            </p>
                        </div>
                        <div class="flex gap-5 justify-between mt-2 mb-2">
                            <p class="text-gray-500 text-sm">Payment Card Number: XXXX XXXX XXXX {{
                                booking.paymentDetails.cardno.slice(-4) }}</p>
                        </div>

                        <hr class="mb-2 mt-2" />

                        <!-- Display user profile data -->
                        <h5 class="text-lg text-gray-500 dark:text-gray-400">Personal Details</h5>
                        <div *ngIf="userProfiles[i]">
                            <div class="flex gap-5 justify-between mt-2 mb-2">
                                <p class="text-gray-500 text-sm">User Name: {{ userProfiles[i].firstname }} {{
                                    userProfiles[i].lastname }}</p>
                                <p class="text-gray-500 text-sm">Email: {{ userProfiles[i].email }}</p>
                            </div>
                            <div class="flex gap-5 justify-between mt-2 mb-2">
                                <p class="text-gray-500 text-sm">Mobile: {{ userProfiles[i].mobile }}</p>
                                <p class="text-gray-500 text-sm">Address: {{ userProfiles[i].address }}</p>
                            </div>

                            <div class="flex gap-5 justify-between mt-2 mb-2">
                                <p class="text-gray-500 text-sm">Location : {{userProfiles[i].location.city}} -
                                    {{userProfiles[i].location.state}}</p>
                            </div>
                        </div>



                    </div>

                    <div *ngIf="booking.visitingStatus === 'not visited' && isFutureTime(booking.bookedForDate, calculateExpectedEndTime(booking.timeForBooked, booking.totalHoursEvBooking))"
                        class="px-4 py-2 rounded-b-lg  bg-gray-200">
                        <button type="button" class="bg-green-500 flex justify-between items-center gap-4 text-white rounded-lg px-2
                            py-1">
                            <span>Mark as Visited</span>
                            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px"
                                viewBox="0 0 122.88 122.87" style="enable-background:new 0 0 122.88 122.87"
                                xml:space="preserve">
                                <style type="text/css">
                                    .st0 {
                                        fill: #ffffff;
                                    }

                                    .st1 {
                                        fill: #000;
                                    }
                                </style>
                                <g>
                                    <path class="st0"
                                        d="M32.82,51.34l14.99-0.2l1.12,0.29c3.03,1.74,5.88,3.74,8.54,5.99c1.92,1.63,3.76,3.4,5.5,5.32 c5.38-8.65,11.11-16.6,17.16-23.9c6.63-8,13.66-15.27,21.05-21.9l1.46-0.56h16.36l-3.3,3.66c-10.13,11.26-19.33,22.9-27.64,34.9 C79.74,66.97,72.31,79.37,65.7,92.13l-2.06,3.97l-1.89-4.04c-3.49-7.48-7.66-14.35-12.64-20.49c-4.98-6.14-10.77-11.59-17.52-16.22 L32.82,51.34L32.82,51.34L32.82,51.34z" />
                                    <path class="st1"
                                        d="M61.44,0c9.53,0,18.55,2.17,26.61,6.04c-3.3,2.61-6.36,5.11-9.21,7.53c-5.43-1.97-11.28-3.05-17.39-3.05 c-14.06,0-26.79,5.7-36,14.92c-9.21,9.22-14.92,21.94-14.92,36c0,14.06,5.7,26.78,14.92,36s21.94,14.92,36,14.92 c14.06,0,26.79-5.7,36-14.92c9.22-9.22,14.91-21.94,14.91-36c0-3.34-0.32-6.62-0.94-9.78c2.64-3.44,5.35-6.88,8.11-10.28 c2.17,6.28,3.35,13.04,3.35,20.06c0,16.96-6.88,32.33-17.99,43.44c-11.12,11.12-26.48,18-43.44,18c-16.96,0-32.32-6.88-43.44-18 C6.88,93.76,0,78.4,0,61.44C0,44.47,6.88,29.11,17.99,18C29.11,6.88,44.47,0,61.44,0L61.44,0L61.44,0z" />
                                </g>
                            </svg>
                        </button>
                    </div>

                    <div *ngIf="booking.visitingStatus === 'not visited' && !isFutureTime(booking.bookedForDate, calculateExpectedEndTime(booking.timeForBooked, booking.totalHoursEvBooking)  )"
                        class="px-4 py-2 rounded-b-lg bg-gray-200">
                        <p class="text-sm text-gray-500">User not visited </p>
                    </div>




                    <div *ngIf="booking.visitingStatus === 'visited'"
                        class="px-4 py-2 rounded-b-lg flex gap-2 justify-between items-center bg-green-200">
                        <p class="text-sm text-gray-500">Visited</p>
                        <button (click)="toggleModal(booking)"
                            class="bg-green-700 text-white flex gap-2 justify-center items-center px-3 py-1 rounded-lg">Rate
                            Us
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                class="h-8 w-8" version="1.1" id="Capa_1" viewBox="0 0 47.94 47.94"
                                xml:space="preserve">
                                <path style="fill:#ED8A19;"
                                    d="M26.285,2.486l5.407,10.956c0.376,0.762,1.103,1.29,1.944,1.412l12.091,1.757  c2.118,0.308,2.963,2.91,1.431,4.403l-8.749,8.528c-0.608,0.593-0.886,1.448-0.742,2.285l2.065,12.042  c0.362,2.109-1.852,3.717-3.746,2.722l-10.814-5.685c-0.752-0.395-1.651-0.395-2.403,0l-10.814,5.685  c-1.894,0.996-4.108-0.613-3.746-2.722l2.065-12.042c0.144-0.837-0.134-1.692-0.742-2.285l-8.749-8.528  c-1.532-1.494-0.687-4.096,1.431-4.403l12.091-1.757c0.841-0.122,1.568-0.65,1.944-1.412l5.407-10.956  C22.602,0.567,25.338,0.567,26.285,2.486z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </ng-container>
        </div>


        <div class="flex justify-center items-center"><svg *ngIf="!filteredBookings" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" style="margin:auto;display:block;" width="100px"
                height="100px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
                <path d="M10 50A40 40 0 0 0 90 50A40 42 0 0 1 10 50" fill="#36e30c" stroke="none">
                    <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite"
                        keyTimes="0;1" values="0 50 51;360 50 51"></animateTransform>
                </path>
            </svg></div>


    </div>
</div>


<!-- Opening rating modal when click -->
<div class="min-h-screen bg-black bg-opacity-50 py-6 flex flex-col justify-center sm:py-12 fixed inset-0 z-50"
    *ngIf="showModal">
    <div class="py-3 sm:max-w-xl sm:mx-auto">
        <div class="bg-white min-w-1xl flex flex-col rounded-xl shadow-lg">
            <div class="px-12 py-5">
                <h2 class="text-gray-800 text-3xl font-semibold">Your opinion matters to us!</h2>
            </div>
            <div class="bg-gray-200 w-full flex flex-col items-center">
                <div class="flex flex-col items-center py-6 space-y-3">
                    <span class="text-md text-gray-800">How was quality of the EvStation
                        {{selectedBooking.stationId}}?</span>
                    <div class="flex space-x-3">
                        <svg *ngFor="let star of stars; let i = index" [class]="star.class"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            (click)="rate(i + 1)">
                            <path
                                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                    </div>
                    <p>You rated {{ filledStars }}/5</p>
                </div>
                <div class="w-3/4 flex flex-col">
                    <textarea rows="3" class="p-4 text-gray-500 rounded-xl resize-none"
                        placeholder="Leave a message, if you want" [(ngModel)]="feedbackMsg"
                        name="feedbackMsg"></textarea>
                    <button (click)="rateNow(this.selectedBooking)"
                        class="py-3 my-8 text-lg bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl text-white">Rate
                        now</button>
                </div>
            </div>
            <div class="h-20 flex items-center justify-center">
                <button type="button" (click)="toggleClose()" class="text-gray-600">Maybe later</button>
            </div>
        </div>


    </div>
</div>